{% extends "layout.html" %}

{% block title %}涨停连板分析{% endblock %}

{% block extra_css %}
<style>
    /* 涨停分析专用样式 */
    .zhangting-container {
        background-color: #f8f9fa;
        min-height: 100vh;
        padding: 20px 0;
    }
    
    .zhangting-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 2rem 0;
        margin-bottom: 2rem;
        border-radius: 0 0 20px 20px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    
    .zhangting-title {
        font-size: 2.5rem;
        font-weight: bold;
        text-align: center;
        margin-bottom: 0.5rem;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }
    
    .zhangting-subtitle {
        text-align: center;
        font-size: 1.1rem;
        opacity: 0.9;
    }
    
    /* 指标卡片样式 */
    .metric-card {
        background: white;
        border-radius: 15px;
        padding: 1.5rem;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        transition: all 0.3s ease;
        height: 100%;
        border-left: 4px solid #667eea;
    }
    
    .metric-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 15px rgba(0,0,0,0.2);
    }
    
    .metric-title {
        color: #6c757d;
        font-size: 0.9rem;
        font-weight: 500;
        margin-bottom: 0.5rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .metric-value {
        color: #2c3e50;
        font-size: 2rem;
        font-weight: bold;
        margin-bottom: 0.5rem;
    }
    
    .metric-change {
        font-size: 0.85rem;
        font-weight: 500;
    }
    
    .metric-change.positive {
        color: #28a745;
    }
    
    .metric-change.negative {
        color: #dc3545;
    }
    
    .metric-change.neutral {
        color: #6c757d;
    }
    
    /* 情绪指标样式 */
    .sentiment-card {
        background: white;
        border-radius: 15px;
        padding: 1.5rem;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        text-align: center;
        height: 100%;
    }
    
    .sentiment-score {
        font-size: 3rem;
        font-weight: bold;
        margin: 1rem 0;
    }
    
    .sentiment-level-1 { color: #007bff; }  /* 冷淡 */
    .sentiment-level-2 { color: #17a2b8; }  /* 偏冷 */
    .sentiment-level-3 { color: #ffc107; }  /* 一般 */
    .sentiment-level-4 { color: #fd7e14; }  /* 较热 */
    .sentiment-level-5 { color: #dc3545; }  /* 极热 */
    
    /* 数据表格样式 */
    .data-table {
        background: white;
        border-radius: 15px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        overflow: hidden;
    }
    
    .data-table .table {
        margin-bottom: 0;
    }
    
    .data-table .table thead th {
        background-color: #667eea;
        color: white;
        border: none;
        font-weight: 600;
        text-align: center;
        padding: 1rem 0.75rem;
    }
    
    .data-table .table tbody td {
        padding: 0.75rem;
        text-align: center;
        vertical-align: middle;
        border-color: #dee2e6;
    }
    
    .data-table .table tbody tr:hover {
        background-color: #f8f9fa;
    }
    
    /* 概念标签样式 */
    .concept-tag {
        display: inline-block;
        background-color: #e9ecef;
        color: #495057;
        padding: 0.25rem 0.5rem;
        margin: 0.1rem;
        border-radius: 15px;
        font-size: 0.8rem;
        font-weight: 500;
    }
    
    .concept-tag.hot {
        background-color: #dc3545;
        color: white;
    }
    
    .concept-tag.warm {
        background-color: #fd7e14;
        color: white;
    }
    
    .concept-tag.normal {
        background-color: #17a2b8;
        color: white;
    }
    
    /* 连板徽章样式 */
    .lianban-badge {
        display: inline-block;
        padding: 0.25rem 0.5rem;
        border-radius: 0.375rem;
        font-size: 0.75rem;
        font-weight: 600;
        text-align: center;
        white-space: nowrap;
    }
    
    .lianban-1 {
        background-color: #28a745;
        color: white;
    }
    
    .lianban-2 {
        background-color: #fd7e14;
        color: white;
    }
    
    .lianban-3 {
        background-color: #dc3545;
        color: white;
    }
    
    .lianban-high {
        background-color: #6f42c1;
        color: white;
    }
    
    /* 图表容器样式 */
    .chart-container {
        background: white;
        border-radius: 15px;
        padding: 1.5rem;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        margin-bottom: 2rem;
    }
    
    .chart-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: #2c3e50;
        margin-bottom: 1rem;
        text-align: center;
    }
    
    /* 日期选择器样式 */
    .date-selector {
        background: white;
        border-radius: 15px;
        padding: 1rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 2rem;
    }
    
    .date-selector .form-select {
        border-radius: 10px;
        border: 2px solid #e9ecef;
        padding: 0.75rem;
        font-weight: 500;
    }
    
    .date-selector .form-select:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
    }
    
    /* 加载动画 */
    .loading-spinner {
        text-align: center;
        padding: 2rem;
    }
    
    .spinner-border {
        color: #667eea;
    }
    
    /* 响应式设计 */
    @media (max-width: 768px) {
        .zhangting-title {
            font-size: 2rem;
        }
        
        .metric-value {
            font-size: 1.5rem;
        }
        
        .sentiment-score {
            font-size: 2rem;
        }
        
        .data-table {
            font-size: 0.9rem;
        }
    }
    
    /* 动画效果 */
    .fade-in {
        animation: fadeIn 0.6s ease-in-out;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    .slide-in {
        animation: slideIn 0.5s ease-out;
    }
    
    @keyframes slideIn {
        from { opacity: 0; transform: translateX(-20px); }
        to { opacity: 1; transform: translateX(0); }
    }
</style>
{% endblock %}

{% block content %}
<div class="zhangting-container">
    <!-- 页面头部 -->
    <div class="zhangting-header">
        <div class="container">
            <h1 class="zhangting-title">📈 涨停连板分析</h1>
            <p class="zhangting-subtitle">实时监控涨停股票，分析连板结构，把握市场热点</p>
        </div>
    </div>
    
    <div class="container">
        <!-- 日期选择器 -->
        <div class="date-selector">
            <div class="row align-items-center">
                <div class="col-md-3">
                    <label for="tradeDateSelect" class="form-label fw-bold">选择交易日期</label>
                </div>
                <div class="col-md-6">
                    <select class="form-select" id="tradeDateSelect" onchange="loadZhangTingData()">
                        <option value="">加载中...</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <button class="btn btn-primary" onclick="refreshData()">
                        <i class="fas fa-sync-alt"></i> 刷新数据
                    </button>
                    <button class="btn btn-secondary ms-2" onclick="testAPI()">
                        <i class="fas fa-bug"></i> 测试API
                    </button>
                </div>
            </div>
        </div>
        
        <!-- 调试信息面板 -->
        <div id="debugPanel" class="alert alert-info" style="display: none;">
            <h6><i class="fas fa-bug"></i> 调试信息</h6>
            <div id="debugLog"></div>
        </div>
        
        <!-- 数据加载状态 -->
        <div id="loadingSpinner" class="loading-spinner" style="display: none;">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">正在加载涨停数据...</p>
        </div>
        
        <!-- 概览指标 -->
        <div id="overviewMetrics" class="row g-4 mb-4" style="display: none;">
            <div class="col-lg-2 col-md-4 col-sm-6">
                <div class="metric-card fade-in">
                    <div class="metric-title">涨停总数</div>
                    <div class="metric-value" id="totalCount">-</div>
                    <div class="metric-change neutral" id="totalCountChange">-</div>
                </div>
            </div>
            <div class="col-lg-2 col-md-4 col-sm-6">
                <div class="metric-card fade-in">
                    <div class="metric-title">最高连板</div>
                    <div class="metric-value" id="maxLianban">-</div>
                    <div class="metric-change neutral" id="maxLianbanChange">-</div>
                </div>
            </div>
            <div class="col-lg-2 col-md-4 col-sm-6">
                <div class="metric-card fade-in">
                    <div class="metric-title">首板数量</div>
                    <div class="metric-value" id="firstBoardCount">-</div>
                    <div class="metric-change neutral" id="firstBoardChange">-</div>
                </div>
            </div>
            <div class="col-lg-2 col-md-4 col-sm-6">
                <div class="metric-card fade-in">
                    <div class="metric-title">高度板数</div>
                    <div class="metric-value" id="highBoardCount">-</div>
                    <div class="metric-change neutral" id="highBoardChange">-</div>
                </div>
            </div>
            <div class="col-lg-2 col-md-4 col-sm-6">
                <div class="metric-card fade-in">
                    <div class="metric-title">总成交额</div>
                    <div class="metric-value" id="totalAmount">-</div>
                    <div class="metric-change neutral" id="totalAmountChange">-</div>
                </div>
            </div>
            <div class="col-lg-2 col-md-4 col-sm-6">
                <div class="sentiment-card fade-in">
                    <div class="metric-title">市场情绪</div>
                    <div class="sentiment-score" id="sentimentScore">-</div>
                    <div id="sentimentLevel">-</div>
                </div>
            </div>
        </div>
        
        <!-- 主要内容区域 -->
        <div id="mainContent" style="display: none;">
            <div class="row g-4">
                <!-- 左侧：龙头股票和连板统计 -->
                <div class="col-lg-8">
                    <!-- 龙头股票表格 -->
                    <div class="data-table mb-4 slide-in">
                        <div class="chart-title">🏆 龙头股票排行</div>
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>排名</th>
                                        <th>股票代码</th>
                                        <th>股票名称</th>
                                        <th>连板天数</th>
                                        <th>涨跌幅(%)</th>
                                        <th>最新价(元)</th>
                                        <th>成交额(万)</th>
                                        <th>涨停原因</th>
                                    </tr>
                                </thead>
                                <tbody id="leaderStocksTable">
                                    <!-- 动态填充 -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- 连板晋级率 -->
                    <div class="data-table slide-in">
                        <div class="chart-title">📊 连板晋级率分析</div>
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>连板类型</th>
                                        <th>昨日数量</th>
                                        <th>今日晋级</th>
                                        <th>晋级率(%)</th>
                                        <th>评级</th>
                                    </tr>
                                </thead>
                                <tbody id="promotionRateTable">
                                    <!-- 动态填充 -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- 右侧：概念统计和连板分布 -->
                <div class="col-lg-4">
                    <!-- 热门概念 -->
                    <div class="data-table mb-4 slide-in">
                        <div class="chart-title">🔥 热门概念排行</div>
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>概念</th>
                                        <th>数量</th>
                                        <th>占比(%)</th>
                                    </tr>
                                </thead>
                                <tbody id="conceptTable">
                                    <!-- 动态填充 -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- 连板分布 -->
                    <div class="chart-container slide-in">
                        <div class="chart-title">📈 连板分布统计</div>
                        <div id="lianbandistributionChart"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 错误提示 -->
        <div id="errorMessage" class="alert alert-danger" style="display: none;">
            <i class="fas fa-exclamation-triangle"></i>
            <span id="errorText">加载数据时发生错误</span>
        </div>
        
        <!-- 无数据提示 -->
        <div id="noDataMessage" class="alert alert-info" style="display: none;">
            <i class="fas fa-info-circle"></i>
            所选日期暂无涨停数据，请选择其他交易日期。
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
<script>
// 全局变量
let currentTradeDate = null;
let zhangTingData = null;

// 页面加载完成后初始化
document.addEventListener('DOMContentLoaded', function() {
    loadTradingDates();
});

// 加载交易日期列表
async function loadTradingDates() {
    console.log('开始加载交易日期...');
    try {
        const response = await fetch('/api/zhangting/trading_dates');
        console.log('API响应状态:', response.status);
        
        if (!response.ok) {
            throw new Error(`API请求失败: ${response.status}`);
        }
        
        const dates = await response.json();
        console.log('获取到的日期数据:', dates);
        
        const selectElement = document.getElementById('tradeDateSelect');
        if (!selectElement) {
            throw new Error('找不到日期选择器元素');
        }
        
        selectElement.innerHTML = '<option value="">请选择日期...</option>';
        
        dates.forEach((date, index) => {
            const option = document.createElement('option');
            option.value = date;
            option.textContent = formatDate(date);
            if (index === 0) {
                option.selected = true;
                currentTradeDate = date;
            }
            selectElement.appendChild(option);
        });
        
        console.log(`成功加载${dates.length}个交易日期`);
        
        // 自动加载最新日期的数据
        if (dates.length > 0) {
            loadZhangTingData();
        }
    } catch (error) {
        console.error('加载交易日期失败:', error);
        showError('加载交易日期失败，请刷新页面重试: ' + error.message);
    }
}

// 加载涨停数据
async function loadZhangTingData() {
    const selectedDate = document.getElementById('tradeDateSelect').value;
    console.log('开始加载涨停数据，选中日期:', selectedDate);
    
    if (!selectedDate) {
        console.log('未选择日期，跳过数据加载');
        return;
    }
    
    currentTradeDate = selectedDate;
    showLoading(true);
    hideError();
    hideNoData();
    hideMainContent();
    
    try {
        console.log('开始并行请求数据...');
        // 并行加载所有数据
        const [dataResponse, statsResponse, conceptResponse, sentimentResponse] = await Promise.all([
            fetch(`/api/zhangting/data?date=${selectedDate}`),
            fetch(`/api/zhangting/statistics?date=${selectedDate}`),
            fetch(`/api/zhangting/concepts?date=${selectedDate}`),
            fetch(`/api/zhangting/sentiment?date=${selectedDate}`)
        ]);
        
        console.log('API响应状态:', {
            data: dataResponse.status,
            stats: statsResponse.status,
            concepts: conceptResponse.status,
            sentiment: sentimentResponse.status
        });
        
        const data = await dataResponse.json();
        const stats = await statsResponse.json();
        const concepts = await conceptResponse.json();
        const sentiment = await sentimentResponse.json();
        
        console.log('解析后的数据:', { data, stats, concepts, sentiment });
        
        if (data && data.length > 0) {
            console.log(`成功获取${data.length}条涨停数据`);
            zhangTingData = data;
            updateOverviewMetrics(stats, sentiment);
            updateLeaderStocksTable(data);
            updateConceptTable(concepts);
            updateLianbanDistributionChart(stats);
            loadPromotionRateData();
            showMainContent();
        } else {
            console.log('没有获取到涨停数据');
            showNoData();
        }
    } catch (error) {
        console.error('加载涨停数据失败:', error);
        showError('加载涨停数据失败，请稍后重试: ' + error.message);
    } finally {
        showLoading(false);
    }
}

// 加载晋级率数据
async function loadPromotionRateData() {
    if (!currentTradeDate) return;
    
    try {
        const response = await fetch(`/api/zhangting/promotion_rate?date=${currentTradeDate}`);
        const promotionData = await response.json();
        updatePromotionRateTable(promotionData);
    } catch (error) {
        console.error('加载晋级率数据失败:', error);
    }
}

// 更新概览指标
function updateOverviewMetrics(stats, sentiment) {
    document.getElementById('totalCount').textContent = stats.总涨停数量 || 0;
    document.getElementById('maxLianban').textContent = stats.最高连板 || 0;
    document.getElementById('firstBoardCount').textContent = stats.首板数量 || 0;
    document.getElementById('highBoardCount').textContent = stats.三板以上数量 || 0;
    document.getElementById('totalAmount').textContent = formatAmount(stats.总成交额 || 0);
    
    // 更新情绪指标
    const sentimentScore = sentiment.热度评分 || 1;
    const sentimentLevel = sentiment.市场热度 || '冷淡';
    
    document.getElementById('sentimentScore').textContent = sentimentScore;
    document.getElementById('sentimentLevel').textContent = sentimentLevel;
    
    // 设置情绪颜色
    const scoreElement = document.getElementById('sentimentScore');
    scoreElement.className = `sentiment-score sentiment-level-${sentimentScore}`;
    
    // 显示概览区域
    document.getElementById('overviewMetrics').style.display = 'block';
}

// 更新龙头股票表格
function updateLeaderStocksTable(data) {
    const tbody = document.getElementById('leaderStocksTable');
    tbody.innerHTML = '';
    
    data.slice(0, 10).forEach((stock, index) => {
        const row = document.createElement('tr');
        
        // 连板徽章样式
        let lianbandBadgeClass = 'lianban-1';
        const lianbanDays = stock.连续涨停天数 || 1;
        if (lianbanDays >= 4) lianbandBadgeClass = 'lianban-high';
        else if (lianbanDays === 3) lianbandBadgeClass = 'lianban-3';
        else if (lianbanDays === 2) lianbandBadgeClass = 'lianban-2';
        
        row.innerHTML = `
            <td><strong>${index + 1}</strong></td>
            <td><code>${stock.股票代码}</code></td>
            <td><strong>${stock.股票名称}</strong></td>
            <td><span class="lianban-badge ${lianbandBadgeClass}">${lianbanDays}板</span></td>
            <td><span class="text-danger">${(stock['涨跌幅(%)'] || stock.涨跌幅 || 0).toFixed(2)}%</span></td>
            <td>¥${(stock.最新价 || 0).toFixed(2)}</td>
            <td>${formatNumber(stock['成交额(万)'] || stock.成交额 / 10000 || 0)}</td>
            <td><small>${formatConcepts(stock.涨停原因 || '-')}</small></td>
        `;
        tbody.appendChild(row);
    });
}

// 更新概念表格
function updateConceptTable(concepts) {
    const tbody = document.getElementById('conceptTable');
    tbody.innerHTML = '';
    
    concepts.slice(0, 15).forEach(concept => {
        const row = document.createElement('tr');
        
        // 概念热度标签
        let conceptClass = 'normal';
        if (concept['占比(%)'] >= 15) conceptClass = 'hot';
        else if (concept['占比(%)'] >= 8) conceptClass = 'warm';
        
        row.innerHTML = `
            <td><span class="concept-tag ${conceptClass}">${concept.概念}</span></td>
            <td><strong>${concept.涨停数量}</strong></td>
            <td>${concept['占比(%)'].toFixed(1)}%</td>
        `;
        tbody.appendChild(row);
    });
}

// 更新晋级率表格
function updatePromotionRateTable(promotionData) {
    const tbody = document.getElementById('promotionRateTable');
    tbody.innerHTML = '';
    
    promotionData.forEach(item => {
        const row = document.createElement('tr');
        
        // 晋级率评级
        let rating = '一般';
        let ratingClass = 'text-warning';
        const rate = item['晋级率(%)'] || 0;
        
        if (rate >= 80) {
            rating = '优秀';
            ratingClass = 'text-success';
        } else if (rate >= 60) {
            rating = '良好';
            ratingClass = 'text-info';
        } else if (rate >= 40) {
            rating = '一般';
            ratingClass = 'text-warning';
        } else {
            rating = '较差';
            ratingClass = 'text-danger';
        }
        
        row.innerHTML = `
            <td><strong>${item.连板类型}</strong></td>
            <td>${item.昨日数量}</td>
            <td>${item.今日晋级}</td>
            <td><strong>${rate.toFixed(1)}%</strong></td>
            <td><span class="${ratingClass}">${rating}</span></td>
        `;
        tbody.appendChild(row);
    });
}

// 更新连板分布图表
function updateLianbanDistributionChart(stats) {
    if (!stats.连板分布) return;
    
    const distribution = stats.连板分布;
    const categories = Object.keys(distribution).map(key => `${key}板`);
    const values = Object.values(distribution);
    
    const option = {
        tooltip: {
            trigger: 'item',
            formatter: '{b}: {c}只 ({d}%)'
        },
        series: [{
            type: 'pie',
            radius: ['40%', '70%'],
            data: categories.map((name, index) => ({
                name: name,
                value: values[index]
            })),
            emphasis: {
                itemStyle: {
                    shadowBlur: 10,
                    shadowOffsetX: 0,
                    shadowColor: 'rgba(0, 0, 0, 0.5)'
                }
            }
        }]
    };
    
    const chart = echarts.init(document.getElementById('lianbandistributionChart'));
    chart.setOption(option);
}

// 工具函数
function formatDate(dateStr) {
    const date = new Date(dateStr);
    const weekdays = ['周日', '周一', '周二', '周三', '周四', '周五', '周六'];
    const weekday = weekdays[date.getDay()];
    return `${dateStr} ${weekday}`;
}

function formatAmount(amount) {
    if (amount >= 100000000) {
        return (amount / 100000000).toFixed(1) + '亿';
    } else if (amount >= 10000) {
        return (amount / 10000).toFixed(1) + '万';
    }
    return amount.toString();
}

function formatNumber(num) {
    return new Intl.NumberFormat('zh-CN').format(Math.round(num));
}

function formatConcepts(concepts) {
    if (!concepts || concepts === '-') return '-';
    const conceptList = concepts.split('+');
    return conceptList.slice(0, 2).join(', ') + (conceptList.length > 2 ? '...' : '');
}

function showLoading(show) {
    document.getElementById('loadingSpinner').style.display = show ? 'block' : 'none';
}

function showMainContent() {
    document.getElementById('mainContent').style.display = 'block';
}

function hideMainContent() {
    document.getElementById('mainContent').style.display = 'none';
}

function showError(message) {
    document.getElementById('errorText').textContent = message;
    document.getElementById('errorMessage').style.display = 'block';
}

function hideError() {
    document.getElementById('errorMessage').style.display = 'none';
}

function showNoData() {
    document.getElementById('noDataMessage').style.display = 'block';
}

function hideNoData() {
    document.getElementById('noDataMessage').style.display = 'none';
}

function refreshData() {
    if (currentTradeDate) {
        loadZhangTingData();
    } else {
        loadTradingDates();
    }
}

// 调试功能
function debugLog(message) {
    console.log(message);
    const debugLogDiv = document.getElementById('debugLog');
    if (debugLogDiv) {
        const timestamp = new Date().toLocaleTimeString();
        debugLogDiv.innerHTML += `<div>${timestamp}: ${message}</div>`;
        document.getElementById('debugPanel').style.display = 'block';
    }
}

function testAPI() {
    debugLog('开始测试API...');
    
    // 测试交易日期API
    fetch('/api/zhangting/trading_dates')
        .then(response => {
            debugLog(`交易日期API响应: ${response.status}`);
            return response.json();
        })
        .then(data => {
            debugLog(`获取到${data.length}个交易日期: ${data.slice(0, 3).join(', ')}...`);
            
            // 测试数据API
            if (data.length > 0) {
                const testDate = data[0];
                debugLog(`测试数据API，使用日期: ${testDate}`);
                
                return fetch(`/api/zhangting/data?date=${testDate}`);
            }
        })
        .then(response => {
            if (response) {
                debugLog(`数据API响应: ${response.status}`);
                return response.json();
            }
        })
        .then(data => {
            if (data) {
                debugLog(`获取到${data.length}条涨停数据`);
                debugLog('API测试完成 ✅');
            }
        })
        .catch(error => {
            debugLog(`API测试失败: ${error.message} ❌`);
        });
}
</script>
{% endblock %}
