{% extends "layout.html" %}

{% block title %}æ¶¨åœè¿æ¿åˆ†æ{% endblock %}

{% block extra_css %}
<style>
    /* æ¶¨åœåˆ†æä¸“ç”¨æ ·å¼ */
    .zhangting-container {
        background-color: #f8f9fa;
        min-height: 100vh;
        padding: 20px 0;
    }
    
    .zhangting-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 2rem 0;
        margin-bottom: 2rem;
        border-radius: 0 0 20px 20px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    
    .zhangting-title {
        font-size: 2.5rem;
        font-weight: bold;
        text-align: center;
        margin-bottom: 0.5rem;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }
    
    .zhangting-subtitle {
        text-align: center;
        font-size: 1.1rem;
        opacity: 0.9;
    }
    
    /* æŒ‡æ ‡å¡ç‰‡æ ·å¼ */
    .metric-card {
        background: white;
        border-radius: 15px;
        padding: 1.5rem;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        transition: all 0.3s ease;
        height: 100%;
        border-left: 4px solid #667eea;
    }
    
    .metric-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 15px rgba(0,0,0,0.2);
    }
    
    .metric-title {
        color: #6c757d;
        font-size: 0.9rem;
        font-weight: 500;
        margin-bottom: 0.5rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .metric-value {
        color: #2c3e50;
        font-size: 2rem;
        font-weight: bold;
        margin-bottom: 0.5rem;
    }
    
    .metric-change {
        font-size: 0.85rem;
        font-weight: 500;
    }
    
    .metric-change.positive {
        color: #28a745;
    }
    
    .metric-change.negative {
        color: #dc3545;
    }
    
    .metric-change.neutral {
        color: #6c757d;
    }
    
    /* æƒ…ç»ªæŒ‡æ ‡æ ·å¼ */
    .sentiment-card {
        background: white;
        border-radius: 15px;
        padding: 1.5rem;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        text-align: center;
        height: 100%;
    }
    
    .sentiment-score {
        font-size: 3rem;
        font-weight: bold;
        margin: 1rem 0;
    }
    
    .sentiment-level-1 { color: #007bff; }  /* å†·æ·¡ */
    .sentiment-level-2 { color: #17a2b8; }  /* åå†· */
    .sentiment-level-3 { color: #ffc107; }  /* ä¸€èˆ¬ */
    .sentiment-level-4 { color: #fd7e14; }  /* è¾ƒçƒ­ */
    .sentiment-level-5 { color: #dc3545; }  /* æçƒ­ */
    
    /* æ•°æ®è¡¨æ ¼æ ·å¼ */
    .data-table {
        background: white;
        border-radius: 15px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        overflow: hidden;
    }
    
    .data-table .table {
        margin-bottom: 0;
    }
    
    .data-table .table thead th {
        background-color: #667eea;
        color: white;
        border: none;
        font-weight: 600;
        text-align: center;
        padding: 1rem 0.75rem;
    }
    
    .data-table .table tbody td {
        padding: 0.75rem;
        text-align: center;
        vertical-align: middle;
        border-color: #dee2e6;
    }
    
    .data-table .table tbody tr:hover {
        background-color: #f8f9fa;
    }
    
    /* æ¦‚å¿µæ ‡ç­¾æ ·å¼ */
    .concept-tag {
        display: inline-block;
        background-color: #e9ecef;
        color: #495057;
        padding: 0.25rem 0.5rem;
        margin: 0.1rem;
        border-radius: 15px;
        font-size: 0.8rem;
        font-weight: 500;
    }
    
    .concept-tag.hot {
        background-color: #dc3545;
        color: white;
    }
    
    .concept-tag.warm {
        background-color: #fd7e14;
        color: white;
    }
    
    .concept-tag.normal {
        background-color: #17a2b8;
        color: white;
    }
    
    /* è¿æ¿å¾½ç« æ ·å¼ */
    .lianban-badge {
        display: inline-block;
        padding: 0.25rem 0.5rem;
        border-radius: 0.375rem;
        font-size: 0.75rem;
        font-weight: 600;
        text-align: center;
        white-space: nowrap;
    }
    
    .lianban-1 {
        background-color: #28a745;
        color: white;
    }
    
    .lianban-2 {
        background-color: #fd7e14;
        color: white;
    }
    
    .lianban-3 {
        background-color: #dc3545;
        color: white;
    }
    
    .lianban-high {
        background-color: #6f42c1;
        color: white;
    }
    
    /* å›¾è¡¨å®¹å™¨æ ·å¼ */
    .chart-container {
        background: white;
        border-radius: 15px;
        padding: 1.5rem;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        margin-bottom: 2rem;
    }
    
    .chart-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: #2c3e50;
        margin-bottom: 1rem;
        text-align: center;
    }
    
    /* æ—¥æœŸé€‰æ‹©å™¨æ ·å¼ */
    .date-selector {
        background: white;
        border-radius: 15px;
        padding: 1rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 2rem;
    }
    
    .date-selector .form-select {
        border-radius: 10px;
        border: 2px solid #e9ecef;
        padding: 0.75rem;
        font-weight: 500;
    }
    
    .date-selector .form-select:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
    }
    
    /* åŠ è½½åŠ¨ç”» */
    .loading-spinner {
        text-align: center;
        padding: 2rem;
    }
    
    .spinner-border {
        color: #667eea;
    }
    
    /* å“åº”å¼è®¾è®¡ */
    @media (max-width: 768px) {
        .zhangting-title {
            font-size: 2rem;
        }
        
        .metric-value {
            font-size: 1.5rem;
        }
        
        .sentiment-score {
            font-size: 2rem;
        }
        
        .data-table {
            font-size: 0.9rem;
        }
    }
    
    /* åŠ¨ç”»æ•ˆæœ */
    .fade-in {
        animation: fadeIn 0.6s ease-in-out;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    .slide-in {
        animation: slideIn 0.5s ease-out;
    }
    
    @keyframes slideIn {
        from { opacity: 0; transform: translateX(-20px); }
        to { opacity: 1; transform: translateX(0); }
    }
</style>
{% endblock %}

{% block content %}
<div class="zhangting-container">
    <!-- é¡µé¢å¤´éƒ¨ -->
    <div class="zhangting-header">
        <div class="container">
            <h1 class="zhangting-title">ğŸ“ˆ æ¶¨åœè¿æ¿åˆ†æ</h1>
            <p class="zhangting-subtitle">å®æ—¶ç›‘æ§æ¶¨åœè‚¡ç¥¨ï¼Œåˆ†æè¿æ¿ç»“æ„ï¼ŒæŠŠæ¡å¸‚åœºçƒ­ç‚¹</p>
        </div>
    </div>
    
    <div class="container">
        <!-- æ—¥æœŸé€‰æ‹©å™¨ -->
        <div class="date-selector">
            <div class="row align-items-center">
                <div class="col-md-3">
                    <label for="tradeDateSelect" class="form-label fw-bold">é€‰æ‹©äº¤æ˜“æ—¥æœŸ</label>
                </div>
                <div class="col-md-6">
                    <select class="form-select" id="tradeDateSelect" onchange="loadZhangTingData()">
                        <option value="">åŠ è½½ä¸­...</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <button class="btn btn-primary" onclick="refreshData()">
                        <i class="fas fa-sync-alt"></i> åˆ·æ–°æ•°æ®
                    </button>
                    <button class="btn btn-secondary ms-2" onclick="testAPI()">
                        <i class="fas fa-bug"></i> æµ‹è¯•API
                    </button>
                </div>
            </div>
        </div>
        
        <!-- è°ƒè¯•ä¿¡æ¯é¢æ¿ -->
        <div id="debugPanel" class="alert alert-info" style="display: none;">
            <h6><i class="fas fa-bug"></i> è°ƒè¯•ä¿¡æ¯</h6>
            <div id="debugLog"></div>
        </div>
        
        <!-- æ•°æ®åŠ è½½çŠ¶æ€ -->
        <div id="loadingSpinner" class="loading-spinner" style="display: none;">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">æ­£åœ¨åŠ è½½æ¶¨åœæ•°æ®...</p>
        </div>
        
        <!-- æ¦‚è§ˆæŒ‡æ ‡ -->
        <div id="overviewMetrics" class="row g-4 mb-4" style="display: none;">
            <div class="col-lg-2 col-md-4 col-sm-6">
                <div class="metric-card fade-in">
                    <div class="metric-title">æ¶¨åœæ€»æ•°</div>
                    <div class="metric-value" id="totalCount">-</div>
                    <div class="metric-change neutral" id="totalCountChange">-</div>
                </div>
            </div>
            <div class="col-lg-2 col-md-4 col-sm-6">
                <div class="metric-card fade-in">
                    <div class="metric-title">æœ€é«˜è¿æ¿</div>
                    <div class="metric-value" id="maxLianban">-</div>
                    <div class="metric-change neutral" id="maxLianbanChange">-</div>
                </div>
            </div>
            <div class="col-lg-2 col-md-4 col-sm-6">
                <div class="metric-card fade-in">
                    <div class="metric-title">é¦–æ¿æ•°é‡</div>
                    <div class="metric-value" id="firstBoardCount">-</div>
                    <div class="metric-change neutral" id="firstBoardChange">-</div>
                </div>
            </div>
            <div class="col-lg-2 col-md-4 col-sm-6">
                <div class="metric-card fade-in">
                    <div class="metric-title">é«˜åº¦æ¿æ•°</div>
                    <div class="metric-value" id="highBoardCount">-</div>
                    <div class="metric-change neutral" id="highBoardChange">-</div>
                </div>
            </div>
            <div class="col-lg-2 col-md-4 col-sm-6">
                <div class="metric-card fade-in">
                    <div class="metric-title">æ€»æˆäº¤é¢</div>
                    <div class="metric-value" id="totalAmount">-</div>
                    <div class="metric-change neutral" id="totalAmountChange">-</div>
                </div>
            </div>
            <div class="col-lg-2 col-md-4 col-sm-6">
                <div class="sentiment-card fade-in">
                    <div class="metric-title">å¸‚åœºæƒ…ç»ª</div>
                    <div class="sentiment-score" id="sentimentScore">-</div>
                    <div id="sentimentLevel">-</div>
                </div>
            </div>
        </div>
        
        <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
        <div id="mainContent" style="display: none;">
            <div class="row g-4">
                <!-- å·¦ä¾§ï¼šé¾™å¤´è‚¡ç¥¨å’Œè¿æ¿ç»Ÿè®¡ -->
                <div class="col-lg-8">
                    <!-- é¾™å¤´è‚¡ç¥¨è¡¨æ ¼ -->
                    <div class="data-table mb-4 slide-in">
                        <div class="chart-title">ğŸ† é¾™å¤´è‚¡ç¥¨æ’è¡Œ</div>
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>æ’å</th>
                                        <th>è‚¡ç¥¨ä»£ç </th>
                                        <th>è‚¡ç¥¨åç§°</th>
                                        <th>è¿æ¿å¤©æ•°</th>
                                        <th>æ¶¨è·Œå¹…(%)</th>
                                        <th>æœ€æ–°ä»·(å…ƒ)</th>
                                        <th>æˆäº¤é¢(ä¸‡)</th>
                                        <th>æ¶¨åœåŸå› </th>
                                    </tr>
                                </thead>
                                <tbody id="leaderStocksTable">
                                    <!-- åŠ¨æ€å¡«å…… -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- è¿æ¿æ™‹çº§ç‡ -->
                    <div class="data-table slide-in">
                        <div class="chart-title">ğŸ“Š è¿æ¿æ™‹çº§ç‡åˆ†æ</div>
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>è¿æ¿ç±»å‹</th>
                                        <th>æ˜¨æ—¥æ•°é‡</th>
                                        <th>ä»Šæ—¥æ™‹çº§</th>
                                        <th>æ™‹çº§ç‡(%)</th>
                                        <th>è¯„çº§</th>
                                    </tr>
                                </thead>
                                <tbody id="promotionRateTable">
                                    <!-- åŠ¨æ€å¡«å…… -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- å³ä¾§ï¼šæ¦‚å¿µç»Ÿè®¡å’Œè¿æ¿åˆ†å¸ƒ -->
                <div class="col-lg-4">
                    <!-- çƒ­é—¨æ¦‚å¿µ -->
                    <div class="data-table mb-4 slide-in">
                        <div class="chart-title">ğŸ”¥ çƒ­é—¨æ¦‚å¿µæ’è¡Œ</div>
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>æ¦‚å¿µ</th>
                                        <th>æ•°é‡</th>
                                        <th>å æ¯”(%)</th>
                                    </tr>
                                </thead>
                                <tbody id="conceptTable">
                                    <!-- åŠ¨æ€å¡«å…… -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- è¿æ¿åˆ†å¸ƒ -->
                    <div class="chart-container slide-in">
                        <div class="chart-title">ğŸ“ˆ è¿æ¿åˆ†å¸ƒç»Ÿè®¡</div>
                        <div id="lianbandistributionChart"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- é”™è¯¯æç¤º -->
        <div id="errorMessage" class="alert alert-danger" style="display: none;">
            <i class="fas fa-exclamation-triangle"></i>
            <span id="errorText">åŠ è½½æ•°æ®æ—¶å‘ç”Ÿé”™è¯¯</span>
        </div>
        
        <!-- æ— æ•°æ®æç¤º -->
        <div id="noDataMessage" class="alert alert-info" style="display: none;">
            <i class="fas fa-info-circle"></i>
            æ‰€é€‰æ—¥æœŸæš‚æ— æ¶¨åœæ•°æ®ï¼Œè¯·é€‰æ‹©å…¶ä»–äº¤æ˜“æ—¥æœŸã€‚
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
<script>
// å…¨å±€å˜é‡
let currentTradeDate = null;
let zhangTingData = null;

// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    loadTradingDates();
});

// åŠ è½½äº¤æ˜“æ—¥æœŸåˆ—è¡¨
async function loadTradingDates() {
    console.log('å¼€å§‹åŠ è½½äº¤æ˜“æ—¥æœŸ...');
    try {
        const response = await fetch('/api/zhangting/trading_dates');
        console.log('APIå“åº”çŠ¶æ€:', response.status);
        
        if (!response.ok) {
            throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status}`);
        }
        
        const dates = await response.json();
        console.log('è·å–åˆ°çš„æ—¥æœŸæ•°æ®:', dates);
        
        const selectElement = document.getElementById('tradeDateSelect');
        if (!selectElement) {
            throw new Error('æ‰¾ä¸åˆ°æ—¥æœŸé€‰æ‹©å™¨å…ƒç´ ');
        }
        
        selectElement.innerHTML = '<option value="">è¯·é€‰æ‹©æ—¥æœŸ...</option>';
        
        dates.forEach((date, index) => {
            const option = document.createElement('option');
            option.value = date;
            option.textContent = formatDate(date);
            if (index === 0) {
                option.selected = true;
                currentTradeDate = date;
            }
            selectElement.appendChild(option);
        });
        
        console.log(`æˆåŠŸåŠ è½½${dates.length}ä¸ªäº¤æ˜“æ—¥æœŸ`);
        
        // è‡ªåŠ¨åŠ è½½æœ€æ–°æ—¥æœŸçš„æ•°æ®
        if (dates.length > 0) {
            loadZhangTingData();
        }
    } catch (error) {
        console.error('åŠ è½½äº¤æ˜“æ—¥æœŸå¤±è´¥:', error);
        showError('åŠ è½½äº¤æ˜“æ—¥æœŸå¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•: ' + error.message);
    }
}

// åŠ è½½æ¶¨åœæ•°æ®
async function loadZhangTingData() {
    const selectedDate = document.getElementById('tradeDateSelect').value;
    console.log('å¼€å§‹åŠ è½½æ¶¨åœæ•°æ®ï¼Œé€‰ä¸­æ—¥æœŸ:', selectedDate);
    
    if (!selectedDate) {
        console.log('æœªé€‰æ‹©æ—¥æœŸï¼Œè·³è¿‡æ•°æ®åŠ è½½');
        return;
    }
    
    currentTradeDate = selectedDate;
    showLoading(true);
    hideError();
    hideNoData();
    hideMainContent();
    
    try {
        console.log('å¼€å§‹å¹¶è¡Œè¯·æ±‚æ•°æ®...');
        // å¹¶è¡ŒåŠ è½½æ‰€æœ‰æ•°æ®
        const [dataResponse, statsResponse, conceptResponse, sentimentResponse] = await Promise.all([
            fetch(`/api/zhangting/data?date=${selectedDate}`),
            fetch(`/api/zhangting/statistics?date=${selectedDate}`),
            fetch(`/api/zhangting/concepts?date=${selectedDate}`),
            fetch(`/api/zhangting/sentiment?date=${selectedDate}`)
        ]);
        
        console.log('APIå“åº”çŠ¶æ€:', {
            data: dataResponse.status,
            stats: statsResponse.status,
            concepts: conceptResponse.status,
            sentiment: sentimentResponse.status
        });
        
        const data = await dataResponse.json();
        const stats = await statsResponse.json();
        const concepts = await conceptResponse.json();
        const sentiment = await sentimentResponse.json();
        
        console.log('è§£æåçš„æ•°æ®:', { data, stats, concepts, sentiment });
        
        if (data && data.length > 0) {
            console.log(`æˆåŠŸè·å–${data.length}æ¡æ¶¨åœæ•°æ®`);
            zhangTingData = data;
            updateOverviewMetrics(stats, sentiment);
            updateLeaderStocksTable(data);
            updateConceptTable(concepts);
            updateLianbanDistributionChart(stats);
            loadPromotionRateData();
            showMainContent();
        } else {
            console.log('æ²¡æœ‰è·å–åˆ°æ¶¨åœæ•°æ®');
            showNoData();
        }
    } catch (error) {
        console.error('åŠ è½½æ¶¨åœæ•°æ®å¤±è´¥:', error);
        showError('åŠ è½½æ¶¨åœæ•°æ®å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•: ' + error.message);
    } finally {
        showLoading(false);
    }
}

// åŠ è½½æ™‹çº§ç‡æ•°æ®
async function loadPromotionRateData() {
    if (!currentTradeDate) return;
    
    try {
        const response = await fetch(`/api/zhangting/promotion_rate?date=${currentTradeDate}`);
        const promotionData = await response.json();
        updatePromotionRateTable(promotionData);
    } catch (error) {
        console.error('åŠ è½½æ™‹çº§ç‡æ•°æ®å¤±è´¥:', error);
    }
}

// æ›´æ–°æ¦‚è§ˆæŒ‡æ ‡
function updateOverviewMetrics(stats, sentiment) {
    document.getElementById('totalCount').textContent = stats.æ€»æ¶¨åœæ•°é‡ || 0;
    document.getElementById('maxLianban').textContent = stats.æœ€é«˜è¿æ¿ || 0;
    document.getElementById('firstBoardCount').textContent = stats.é¦–æ¿æ•°é‡ || 0;
    document.getElementById('highBoardCount').textContent = stats.ä¸‰æ¿ä»¥ä¸Šæ•°é‡ || 0;
    document.getElementById('totalAmount').textContent = formatAmount(stats.æ€»æˆäº¤é¢ || 0);
    
    // æ›´æ–°æƒ…ç»ªæŒ‡æ ‡
    const sentimentScore = sentiment.çƒ­åº¦è¯„åˆ† || 1;
    const sentimentLevel = sentiment.å¸‚åœºçƒ­åº¦ || 'å†·æ·¡';
    
    document.getElementById('sentimentScore').textContent = sentimentScore;
    document.getElementById('sentimentLevel').textContent = sentimentLevel;
    
    // è®¾ç½®æƒ…ç»ªé¢œè‰²
    const scoreElement = document.getElementById('sentimentScore');
    scoreElement.className = `sentiment-score sentiment-level-${sentimentScore}`;
    
    // æ˜¾ç¤ºæ¦‚è§ˆåŒºåŸŸ
    document.getElementById('overviewMetrics').style.display = 'block';
}

// æ›´æ–°é¾™å¤´è‚¡ç¥¨è¡¨æ ¼
function updateLeaderStocksTable(data) {
    const tbody = document.getElementById('leaderStocksTable');
    tbody.innerHTML = '';
    
    data.slice(0, 10).forEach((stock, index) => {
        const row = document.createElement('tr');
        
        // è¿æ¿å¾½ç« æ ·å¼
        let lianbandBadgeClass = 'lianban-1';
        const lianbanDays = stock.è¿ç»­æ¶¨åœå¤©æ•° || 1;
        if (lianbanDays >= 4) lianbandBadgeClass = 'lianban-high';
        else if (lianbanDays === 3) lianbandBadgeClass = 'lianban-3';
        else if (lianbanDays === 2) lianbandBadgeClass = 'lianban-2';
        
        row.innerHTML = `
            <td><strong>${index + 1}</strong></td>
            <td><code>${stock.è‚¡ç¥¨ä»£ç }</code></td>
            <td><strong>${stock.è‚¡ç¥¨åç§°}</strong></td>
            <td><span class="lianban-badge ${lianbandBadgeClass}">${lianbanDays}æ¿</span></td>
            <td><span class="text-danger">${(stock['æ¶¨è·Œå¹…(%)'] || stock.æ¶¨è·Œå¹… || 0).toFixed(2)}%</span></td>
            <td>Â¥${(stock.æœ€æ–°ä»· || 0).toFixed(2)}</td>
            <td>${formatNumber(stock['æˆäº¤é¢(ä¸‡)'] || stock.æˆäº¤é¢ / 10000 || 0)}</td>
            <td><small>${formatConcepts(stock.æ¶¨åœåŸå›  || '-')}</small></td>
        `;
        tbody.appendChild(row);
    });
}

// æ›´æ–°æ¦‚å¿µè¡¨æ ¼
function updateConceptTable(concepts) {
    const tbody = document.getElementById('conceptTable');
    tbody.innerHTML = '';
    
    concepts.slice(0, 15).forEach(concept => {
        const row = document.createElement('tr');
        
        // æ¦‚å¿µçƒ­åº¦æ ‡ç­¾
        let conceptClass = 'normal';
        if (concept['å æ¯”(%)'] >= 15) conceptClass = 'hot';
        else if (concept['å æ¯”(%)'] >= 8) conceptClass = 'warm';
        
        row.innerHTML = `
            <td><span class="concept-tag ${conceptClass}">${concept.æ¦‚å¿µ}</span></td>
            <td><strong>${concept.æ¶¨åœæ•°é‡}</strong></td>
            <td>${concept['å æ¯”(%)'].toFixed(1)}%</td>
        `;
        tbody.appendChild(row);
    });
}

// æ›´æ–°æ™‹çº§ç‡è¡¨æ ¼
function updatePromotionRateTable(promotionData) {
    const tbody = document.getElementById('promotionRateTable');
    tbody.innerHTML = '';
    
    promotionData.forEach(item => {
        const row = document.createElement('tr');
        
        // æ™‹çº§ç‡è¯„çº§
        let rating = 'ä¸€èˆ¬';
        let ratingClass = 'text-warning';
        const rate = item['æ™‹çº§ç‡(%)'] || 0;
        
        if (rate >= 80) {
            rating = 'ä¼˜ç§€';
            ratingClass = 'text-success';
        } else if (rate >= 60) {
            rating = 'è‰¯å¥½';
            ratingClass = 'text-info';
        } else if (rate >= 40) {
            rating = 'ä¸€èˆ¬';
            ratingClass = 'text-warning';
        } else {
            rating = 'è¾ƒå·®';
            ratingClass = 'text-danger';
        }
        
        row.innerHTML = `
            <td><strong>${item.è¿æ¿ç±»å‹}</strong></td>
            <td>${item.æ˜¨æ—¥æ•°é‡}</td>
            <td>${item.ä»Šæ—¥æ™‹çº§}</td>
            <td><strong>${rate.toFixed(1)}%</strong></td>
            <td><span class="${ratingClass}">${rating}</span></td>
        `;
        tbody.appendChild(row);
    });
}

// æ›´æ–°è¿æ¿åˆ†å¸ƒå›¾è¡¨
function updateLianbanDistributionChart(stats) {
    if (!stats.è¿æ¿åˆ†å¸ƒ) return;
    
    const distribution = stats.è¿æ¿åˆ†å¸ƒ;
    const categories = Object.keys(distribution).map(key => `${key}æ¿`);
    const values = Object.values(distribution);
    
    const option = {
        tooltip: {
            trigger: 'item',
            formatter: '{b}: {c}åª ({d}%)'
        },
        series: [{
            type: 'pie',
            radius: ['40%', '70%'],
            data: categories.map((name, index) => ({
                name: name,
                value: values[index]
            })),
            emphasis: {
                itemStyle: {
                    shadowBlur: 10,
                    shadowOffsetX: 0,
                    shadowColor: 'rgba(0, 0, 0, 0.5)'
                }
            }
        }]
    };
    
    const chart = echarts.init(document.getElementById('lianbandistributionChart'));
    chart.setOption(option);
}

// å·¥å…·å‡½æ•°
function formatDate(dateStr) {
    const date = new Date(dateStr);
    const weekdays = ['å‘¨æ—¥', 'å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­'];
    const weekday = weekdays[date.getDay()];
    return `${dateStr} ${weekday}`;
}

function formatAmount(amount) {
    if (amount >= 100000000) {
        return (amount / 100000000).toFixed(1) + 'äº¿';
    } else if (amount >= 10000) {
        return (amount / 10000).toFixed(1) + 'ä¸‡';
    }
    return amount.toString();
}

function formatNumber(num) {
    return new Intl.NumberFormat('zh-CN').format(Math.round(num));
}

function formatConcepts(concepts) {
    if (!concepts || concepts === '-') return '-';
    const conceptList = concepts.split('+');
    return conceptList.slice(0, 2).join(', ') + (conceptList.length > 2 ? '...' : '');
}

function showLoading(show) {
    document.getElementById('loadingSpinner').style.display = show ? 'block' : 'none';
}

function showMainContent() {
    document.getElementById('mainContent').style.display = 'block';
}

function hideMainContent() {
    document.getElementById('mainContent').style.display = 'none';
}

function showError(message) {
    document.getElementById('errorText').textContent = message;
    document.getElementById('errorMessage').style.display = 'block';
}

function hideError() {
    document.getElementById('errorMessage').style.display = 'none';
}

function showNoData() {
    document.getElementById('noDataMessage').style.display = 'block';
}

function hideNoData() {
    document.getElementById('noDataMessage').style.display = 'none';
}

function refreshData() {
    if (currentTradeDate) {
        loadZhangTingData();
    } else {
        loadTradingDates();
    }
}

// è°ƒè¯•åŠŸèƒ½
function debugLog(message) {
    console.log(message);
    const debugLogDiv = document.getElementById('debugLog');
    if (debugLogDiv) {
        const timestamp = new Date().toLocaleTimeString();
        debugLogDiv.innerHTML += `<div>${timestamp}: ${message}</div>`;
        document.getElementById('debugPanel').style.display = 'block';
    }
}

function testAPI() {
    debugLog('å¼€å§‹æµ‹è¯•API...');
    
    // æµ‹è¯•äº¤æ˜“æ—¥æœŸAPI
    fetch('/api/zhangting/trading_dates')
        .then(response => {
            debugLog(`äº¤æ˜“æ—¥æœŸAPIå“åº”: ${response.status}`);
            return response.json();
        })
        .then(data => {
            debugLog(`è·å–åˆ°${data.length}ä¸ªäº¤æ˜“æ—¥æœŸ: ${data.slice(0, 3).join(', ')}...`);
            
            // æµ‹è¯•æ•°æ®API
            if (data.length > 0) {
                const testDate = data[0];
                debugLog(`æµ‹è¯•æ•°æ®APIï¼Œä½¿ç”¨æ—¥æœŸ: ${testDate}`);
                
                return fetch(`/api/zhangting/data?date=${testDate}`);
            }
        })
        .then(response => {
            if (response) {
                debugLog(`æ•°æ®APIå“åº”: ${response.status}`);
                return response.json();
            }
        })
        .then(data => {
            if (data) {
                debugLog(`è·å–åˆ°${data.length}æ¡æ¶¨åœæ•°æ®`);
                debugLog('APIæµ‹è¯•å®Œæˆ âœ…');
            }
        })
        .catch(error => {
            debugLog(`APIæµ‹è¯•å¤±è´¥: ${error.message} âŒ`);
        });
}
</script>
{% endblock %}
