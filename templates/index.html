{% extends "layout.html" %}

{% block title %}é¦–é¡µ - æ™ºèƒ½åˆ†æç³»ç»Ÿ{% endblock %}

{% block content %}
<div class="finance-portal-container">
    <!-- å·¦ä¾§å¯¼èˆªæ  -->
    <div class="portal-sidebar">
        <div class="sidebar-menu">
            <div class="sidebar-header">
                <h5><i class="fas fa-th-list"></i> åŠŸèƒ½å¯¼èˆª</h5>
            </div>
            <div class="sidebar-content">
                <ul class="sidebar-nav">
                    <li><a href="/dashboard"><i class="fas fa-chart-line"></i> æ™ºèƒ½ä»ªè¡¨ç›˜</a></li>
                    <li><a href="/fundamental"><i class="fas fa-file-invoice-dollar"></i> åŸºæœ¬é¢åˆ†æ</a></li>
                    <li><a href="/capital_flow"><i class="fas fa-money-bill-wave"></i> èµ„é‡‘æµå‘</a></li>
                    <li><a href="/market_scan"><i class="fas fa-search"></i> å¸‚åœºæ‰«æ</a></li>
                    <li><a href="/scenario_predict"><i class="fas fa-lightbulb"></i> æƒ…æ™¯é¢„æµ‹</a></li>
                    <li><a href="/portfolio"><i class="fas fa-briefcase"></i> æŠ•èµ„ç»„åˆ</a></li>
                    <li><a href="/qa"><i class="fas fa-question-circle"></i> æ™ºèƒ½é—®ç­”</a></li>
                    <li><a href="/risk_monitor"><i class="fas fa-exclamation-triangle"></i> é£é™©ç›‘æ§</a></li>
                    <li><a href="/industry_analysis"><i class="fas fa-industry"></i> è¡Œä¸šåˆ†æ</a></li>
                    <!-- æ–°å¢é«˜çº§åˆ†æåŠŸèƒ½ -->
                    <li class="nav-separator"><span>ğŸš€ é«˜çº§åˆ†æ</span></li>
                    <li><a href="/market_sentiment"><i class="fas fa-heart-pulse"></i> å¸‚åœºæƒ…ç»ªåˆ†æ</a></li>
                    <li><a href="/rps_analysis"><i class="fas fa-ranking-star"></i> RPSå¼ºåº¦åˆ†æ</a></li>
                    <li><a href="/concept_analysis"><i class="fas fa-tags"></i> æ¦‚å¿µæ¿å—åˆ†æ</a></li>
                </ul>
            </div>
        </div>

<!--        <div class="quick-search mt-4">-->
<!--            <div class="card">-->
<!--                <div class="card-header">-->
<!--                    <h5 class="mb-0"><i class="fas fa-search"></i> å¿«é€Ÿåˆ†æ</h5>-->
<!--                </div>-->
<!--                <div class="card-body">-->
<!--                    <form id="quick-analysis-form">-->
<!--                        <div class="mb-3">-->
<!--                            <label for="quick-stock-code" class="form-label">è‚¡ç¥¨ä»£ç </label>-->
<!--                            <input type="text" class="form-control" id="quick-stock-code" placeholder="ä¾‹å¦‚: 600519">-->
<!--                        </div>-->
<!--                        <div class="mb-3">-->
<!--                            <label for="quick-market-type" class="form-label">å¸‚åœºç±»å‹</label>-->
<!--                            <select class="form-select" id="quick-market-type">-->
<!--                                <option value="A" selected>Aè‚¡</option>-->
<!--                                <option value="HK">æ¸¯è‚¡</option>-->
<!--                                <option value="US">ç¾è‚¡</option>-->
<!--                            </select>-->
<!--                        </div>-->
<!--                        <div class="d-grid">-->
<!--                            <button type="button" class="btn btn-primary" id="quick-analysis-btn">å¼€å§‹åˆ†æ</button>-->
<!--                        </div>-->
<!--                    </form>-->
<!--                </div>-->
<!--            </div>-->
<!--        </div>-->
    </div>

    <!-- ä¸­é—´æ–°é—»åŒºåŸŸ -->
    <div class="portal-news">
        <div class="news-header">
            <h5><i class="fas fa-newspaper"></i> å®æ—¶å¿«è®¯ï¼ˆæ¥æºï¼šè´¢è”ç¤¾ï¼‰</h5>
            <div class="news-tools">
                <button class="btn btn-sm btn-outline-primary refresh-news-btn">
                    <i class="fas fa-sync-alt"></i>
                </button>
                <div class="form-check form-check-inline ms-2">
                    <input class="form-check-input" type="checkbox" id="only-important">
                    <label class="form-check-label" for="only-important">åªçœ‹é‡è¦</label>
                </div>
            </div>
        </div>
        <div class="news-content" id="news-timeline">
            <div class="text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2">åŠ è½½æ–°é—»ä¸­...</p>
            </div>
        </div>
    </div>

    <!-- å³ä¾§çƒ­ç‚¹åŒºåŸŸ -->
    <div class="portal-hotspot">
        <div class="hotspot-header">
            <h5><i class="fas fa-fire"></i> çƒ­ç‚¹</h5>
        </div>
        <div class="hotspot-content" id="hotspot-list">
            <div class="text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2">åŠ è½½çƒ­ç‚¹ä¸­...</p>
            </div>
        </div>
    </div>

    <!-- é¡µè„šå›ºå®šåŒºåŸŸ -->
    <div class="portal-footer">
        <!-- é¡µè„šå¸‚åœºçŠ¶æ€éƒ¨åˆ† -->
        <div class="market-status">
            <div class="market-group">
                <div class="group-title">äºšå¤ªå¸‚åœº</div>
                <div class="status-group">
                    <div class="status-item" id="china-market">
                        <i class="fas fa-circle"></i> Aè‚¡
                        <span class="status-text">åŠ è½½ä¸­...</span>
                    </div>
                    <div class="status-item" id="hk-market">
                        <i class="fas fa-circle"></i> æ¸¯è‚¡
                        <span class="status-text">åŠ è½½ä¸­...</span>
                    </div>
                    <div class="status-item" id="taiwan-market">
                        <i class="fas fa-circle"></i> MSCIä¸­å›½å°æ¹¾
                        <span class="status-text">åŠ è½½ä¸­...</span>
                    </div>
                    <div class="status-item" id="japan-market">
                        <i class="fas fa-circle"></i> æ—¥ç»225
                        <span class="status-text">åŠ è½½ä¸­...</span>
                    </div>
                </div>
            </div>

            <div class="market-group">
                <div class="group-title">æ¬§éä¸­ä¸œ</div>
                <div class="status-group">
                    <div class="status-item" id="uk-market">
                        <i class="fas fa-circle"></i> å¯Œæ—¶100
                        <span class="status-text">åŠ è½½ä¸­...</span>
                    </div>
                    <div class="status-item" id="german-market">
                        <i class="fas fa-circle"></i> å¾·å›½DAX
                        <span class="status-text">åŠ è½½ä¸­...</span>
                    </div>
                    <div class="status-item" id="france-market">
                        <i class="fas fa-circle"></i> æ³•å›½MOEX
                        <span class="status-text">åŠ è½½ä¸­...</span>
                    </div>
                </div>
            </div>

            <div class="market-group">
                <div class="group-title">ç¾æ´²å¸‚åœº</div>
                <div class="status-group">
                    <div class="status-item" id="us-market">
                        <i class="fas fa-circle"></i> ç¾è‚¡
                        <span class="status-text">åŠ è½½ä¸­...</span>
                    </div>
                    <div class="status-item" id="nasdaq-market">
                        <i class="fas fa-circle"></i> çº³æŒ‡
                        <span class="status-text">åŠ è½½ä¸­...</span>
                    </div>
                    <div class="status-item" id="brazil-market">
                        <i class="fas fa-circle"></i> å·´è¥¿
                        <span class="status-text">åŠ è½½ä¸­...</span>
                    </div>
                </div>
            </div>

            <div class="current-time" id="current-time">
                å½“å‰æ—¶é—´: <span>{{ current_time }}</span>
                <span class="refresh-time" id="refresh-time">åˆ·æ–°: 5:00</span>
            </div>
        </div>
        <div class="ticker-news" id="ticker-container">
            <div class="ticker-wrapper">
                <div class="ticker-item">æœ€æ–°æ¶ˆæ¯åŠ è½½ä¸­...</div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
    // å¿«é€Ÿåˆ†ææŒ‰é’®ç‚¹å‡»äº‹ä»¶
    $('#quick-analysis-btn').click(function() {
        const stockCode = $('#quick-stock-code').val().trim();
        const marketType = $('#quick-market-type').val();

        if (!stockCode) {
            alert('è¯·è¾“å…¥è‚¡ç¥¨ä»£ç ');
            return;
        }

        // è·³è½¬åˆ°è‚¡ç¥¨è¯¦æƒ…é¡µ
        window.location.href = `/stock_detail/${stockCode}?market_type=${marketType}`;
    });

    // å›è½¦é”®æäº¤è¡¨å•
    $('#quick-stock-code').keypress(function(e) {
        if (e.which === 13) {
            $('#quick-analysis-btn').click();
            return false;
        }
    });

    // åŠ è½½æœ€æ–°æ–°é—»
    loadLatestNews();

    // åŠ è½½èˆ†æƒ…çƒ­ç‚¹
    loadHotspots();

    // æ›´æ–°å¸‚åœºçŠ¶æ€
    updateMarketStatus();

    // å¯åŠ¨æ»šåŠ¨æ–°é—»
    startTickerNews();

    // åˆ·æ–°æŒ‰é’®ç‚¹å‡»äº‹ä»¶
    $('.refresh-news-btn').click(function() {
        loadLatestNews();
    });

    // åªçœ‹é‡è¦åˆ‡æ¢äº‹ä»¶
    $('#only-important').change(function() {
        loadLatestNews();
    });

    // å®šæ—¶åˆ·æ–°
    setInterval(function() {
        updateMarketStatus();
        // æ¯5åˆ†é’Ÿè‡ªåŠ¨åˆ·æ–°æ–°é—»
        loadLatestNews(true); // é™é»˜åˆ·æ–°
        startTickerNews();
    }, 300000); // 5åˆ†é’Ÿ

    // æ¯ç§’æ›´æ–°å½“å‰æ—¶é—´
    setInterval(function() {
        updateCurrentTime();
    }, 1000);

    // æ¯ç§’æ›´æ–°ä¸€æ¬¡æ—¶é—´å’Œå€’è®¡æ—¶
    setInterval(function() {
        updateCurrentTime();
        updateRefreshCountdown();
    }, 1000);


});

// åŠ è½½æœ€æ–°æ–°é—»å‡½æ•°
function loadLatestNews(silent = false) {
    if (!silent) {
        $('#news-timeline').html(`
            <div class="text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2">åŠ è½½æ–°é—»ä¸­...</p>
            </div>
        `);
    }

    const onlyImportant = $('#only-important').is(':checked');

    $.ajax({
        url: '/api/latest_news',
        method: 'GET',
        data: {
            days: 2,
            limit: 500,
            important: onlyImportant ? 1 : 0
        },
        success: function(response) {
            if (response.success && response.news && response.news.length > 0) {
                displayNewsTimeline(response.news);
            } else {
                if (!silent) {
                    $('#news-timeline').html('<div class="alert alert-info">æš‚æ— æœ€æ–°æ–°é—»</div>');
                }
            }
        },
        error: function(err) {
            console.error('è·å–æ–°é—»å¤±è´¥:', err);
            if (!silent) {
                $('#news-timeline').html('<div class="alert alert-danger">è·å–æ–°é—»å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•</div>');
            }
        }
    });
}

// åŠ è½½èˆ†æƒ…çƒ­ç‚¹å‡½æ•°
function loadHotspots() {
    $('#hotspot-list').html(`
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">åŠ è½½çƒ­ç‚¹ä¸­...</p>
        </div>
    `);

    $.ajax({
        url: '/api/latest_news',
        method: 'GET',
        data: {
            days: 1,
            limit: 10,
            type: 'hotspot'
        },
        success: function(response) {
            if (response.success && response.news && response.news.length > 0) {
                displayHotspots(response.news);
            } else {
                $('#hotspot-list').html('<div class="alert alert-info">æš‚æ— èˆ†æƒ…çƒ­ç‚¹</div>');
            }
        },
        error: function(err) {
            console.error('è·å–çƒ­ç‚¹å¤±è´¥:', err);
            $('#hotspot-list').html('<div class="alert alert-danger">è·å–çƒ­ç‚¹å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•</div>');
        }
    });
}

// æ˜¾ç¤ºçƒ­ç‚¹åˆ—è¡¨
function displayHotspots(hotspots) {
    if (hotspots.length === 0) {
        $('#hotspot-list').html('<div class="alert alert-info">æš‚æ— èˆ†æƒ…çƒ­ç‚¹</div>');
        return;
    }

    let hotspotsHtml = '<div class="hotspot-list">';

    hotspots.forEach((item, index) => {
        const rankClass = index < 3 ? 'rank-top' : '';
        hotspotsHtml += `
            <div class="hotspot-item">
                <span class="hotspot-rank ${rankClass}">${index + 1}</span>
                <span class="hotspot-title">${item.title || item.content}</span>
            </div>
        `;
    });

    hotspotsHtml += '</div>';

    $('#hotspot-list').html(hotspotsHtml);
}

// æ›¿æ¢ç°æœ‰çš„displayNewsTimelineå‡½æ•°
function displayNewsTimeline(newsList) {
    if (newsList.length === 0) {
        $('#news-timeline').html('<div class="alert alert-info">æš‚æ— æ–°é—»</div>');
        return;
    }
    
    let timelineHtml = '<div class="news-timeline-container">';
    
    // é¦–å…ˆæŒ‰å®Œæ•´çš„æ—¥æœŸæ—¶é—´æ’åºï¼Œç¡®ä¿æœ€æ–°æ¶ˆæ¯åœ¨æœ€å‰é¢
    newsList.sort((a, b) => {
        // æ„å»ºå®Œæ•´çš„æ—¥æœŸæ—¶é—´å­—ç¬¦ä¸² (YYYY-MM-DD HH:MM)
        const dateTimeA = (a.date || '') + ' ' + (a.time || '00:00');
        const dateTimeB = (b.date || '') + ' ' + (b.time || '00:00');
        
        // è½¬æ¢ä¸ºDateå¯¹è±¡è¿›è¡Œæ¯”è¾ƒ
        const timeA = new Date(dateTimeA);
        const timeB = new Date(dateTimeB);
        
        // è¿”å›é™åºç»“æœï¼ˆæœ€æ–°çš„åœ¨å‰ï¼‰
        return timeB - timeA;
    });
    
    // æŒ‰å¤©å’Œæ—¶é—´ç‚¹åˆ†ç»„
    const newsGroups = {};
    newsList.forEach(news => {
        // åˆ›å»ºæ ¼å¼ä¸º"YYYY-MM-DD HH:MM"çš„é”®
        const date = news.date || '';
        const time = news.time || '00:00';
        
        // æ˜¾ç¤ºç”¨çš„é”®ï¼šæ—¥æœŸ+æ—¶é—´
        const displayKey = `${date} ${time.substring(0, 5)}`;
        
        if (!newsGroups[displayKey]) {
            newsGroups[displayKey] = [];
        }
        newsGroups[displayKey].push(news);
    });
    
    // è·å–å¹¶æŒ‰æ—¶é—´é™åºæ’åˆ—æ‰€æœ‰ç»„é”®
    const sortedKeys = Object.keys(newsGroups).sort((a, b) => {
        const timeA = new Date(a);
        const timeB = new Date(b);
        return timeB - timeA;
    });
    
    // ç”Ÿæˆæ—¶é—´çº¿HTML
    sortedKeys.forEach(displayKey => {
        const newsItems = newsGroups[displayKey];
        const parts = displayKey.split(' ');
        const date = parts[0];
        const time = parts[1];
        
        // æ ¼å¼åŒ–æ˜¾ç¤ºæ—¥æœŸï¼ˆåªåœ¨æ–°çš„ä¸€å¤©å¼€å§‹æ—¶æ˜¾ç¤ºï¼‰
        const formattedDate = formatDate(date);
        
        timelineHtml += `
            <div class="time-point">
                <div class="time-label">${time}</div>
                <div class="time-date">${formattedDate}</div>
                <div class="news-items">
        `;
        
        newsItems.forEach(news => {
            let contentClass = '';
            // æ ¹æ®å†…å®¹ä¸­æ˜¯å¦å«æœ‰ç‰¹å®šå…³é”®è¯æ·»åŠ æ ·å¼
            if (news.content && (news.content.includes('å¢é•¿') || news.content.includes('ä¸Šæ¶¨') || news.content.includes('åˆ©å¥½'))) {
                contentClass = 'text-success';
            } else if (news.content && (news.content.includes('ä¸‹è·Œ') || news.content.includes('ä¸‹é™') || news.content.includes('åˆ©ç©º'))) {
                contentClass = 'text-danger';
            }
            
            timelineHtml += `
                <div class="news-item">
                    <div class="news-content ${contentClass}">${news.content || ''}</div>
                </div>
            `;
        });
        
        timelineHtml += `
                </div>
            </div>
        `;
    });
    
    timelineHtml += '</div>';
    
    // æ›´æ–°DOM
    $('#news-timeline').html(timelineHtml);
}

// æ—¥æœŸæ ¼å¼åŒ–è¾…åŠ©å‡½æ•°
function formatDate(dateStr) {
    // æ£€æŸ¥æ˜¯å¦ä¸å½“å¤©æ—¥æœŸç›¸åŒ
    const today = new Date();
    const todayStr = today.toISOString().split('T')[0];
    
    if (dateStr === todayStr) {
        return '';
    }
    
    // æ˜¨å¤©
    const yesterday = new Date(today);
    yesterday.setDate(yesterday.getDate() - 1);
    const yesterdayStr = yesterday.toISOString().split('T')[0];
    
    if (dateStr === yesterdayStr) {
        return 'æ˜¨å¤©';
    }
    
    // å…¶ä»–æ—¥æœŸç”¨ä¸­æ–‡æ ¼å¼
    const date = new Date(dateStr);
    return `${date.getMonth() + 1}æœˆ${date.getDate()}æ—¥`;
}

// æ·»åŠ é¡µé¢è‡ªåŠ¨åˆ·æ–°åŠŸèƒ½
let refreshCountdown = 300; // 5åˆ†é’Ÿå€’è®¡æ—¶ï¼ˆç§’ï¼‰

// æ›´æ–°å¸‚åœºçŠ¶æ€
function updateMarketStatus() {
    const now = new Date();
    const hours = now.getHours();
    const minutes = now.getMinutes();
    const weekday = now.getDay(); // 0ä¸ºå‘¨æ—¥ï¼Œ6ä¸ºå‘¨å…­

    // æ£€æŸ¥æ˜¯å¦ä¸ºå·¥ä½œæ—¥
    const isWeekend = weekday === 0 || weekday === 6;

    // äºšå¤ªå¸‚åœºæ—¶åŒº
    // Aè‚¡çŠ¶æ€ (9:30-11:30, 13:00-15:00)
    let chinaStatus = { open: false, text: 'æœªå¼€å¸‚' };
    if (!isWeekend && ((hours === 9 && minutes >= 30) || hours === 10 || (hours === 11 && minutes <= 30) ||
        (hours >= 13 && hours < 15))) {
        chinaStatus = { open: true, text: 'äº¤æ˜“ä¸­' };
    }

    // æ¸¯è‚¡çŠ¶æ€ (9:30-12:00, 13:00-16:00)
    let hkStatus = { open: false, text: 'æœªå¼€å¸‚' };
    if (!isWeekend && ((hours === 9 && minutes >= 30) || hours === 10 || hours === 11 ||
        (hours >= 13 && hours < 16))) {
        hkStatus = { open: true, text: 'äº¤æ˜“ä¸­' };
    }

    // å°è‚¡çŠ¶æ€ (9:00-13:30)
    let taiwanStatus = { open: false, text: 'æœªå¼€å¸‚' };
    if (!isWeekend && ((hours === 9) || hours === 10 || hours === 11 || hours === 12 ||
        (hours === 13 && minutes <= 30))) {
        taiwanStatus = { open: true, text: 'äº¤æ˜“ä¸­' };
    }

    // æ—¥æœ¬è‚¡å¸‚ (9:00-11:30, 12:30-15:00)
    let japanStatus = { open: false, text: 'æœªå¼€å¸‚' };
    if (!isWeekend && ((hours === 9) || hours === 10 || (hours === 11 && minutes <= 30) ||
        (hours === 12 && minutes >= 30) || hours === 13 || hours === 14)) {
        japanStatus = { open: true, text: 'äº¤æ˜“ä¸­' };
    }

    // æ¬§æ´²å¸‚åœº - éœ€è¦è°ƒæ•´æ—¶åŒºï¼Œè¿™é‡Œæ˜¯åŸºäºæ¬§æ´²å¤ä»¤æ—¶(UTC+2)ä¸åŒ—äº¬æ—¶é—´(UTC+8)ç›¸å·®6å°æ—¶è®¡ç®—
    // è‹±å›½è‚¡å¸‚ (ä¼¦æ•¦ï¼ŒåŒ—äº¬æ—¶é—´15:00-23:30)
    let ukStatus = { open: false, text: 'æœªå¼€å¸‚' };
    if (!isWeekend && ((hours >= 15 && hours < 23) || (hours === 23 && minutes <= 30))) {
        ukStatus = { open: true, text: 'äº¤æ˜“ä¸­' };
    }

    // å¾·å›½è‚¡å¸‚ (æ³•å…°å…‹ç¦ï¼ŒåŒ—äº¬æ—¶é—´15:00-23:30)
    let germanStatus = { open: false, text: 'æœªå¼€å¸‚' };
    if (!isWeekend && ((hours >= 15 && hours < 23) || (hours === 23 && minutes <= 30))) {
        germanStatus = { open: true, text: 'äº¤æ˜“ä¸­' };
    }

    // æ³•å›½è‚¡å¸‚ (å·´é»ï¼ŒåŒ—äº¬æ—¶é—´15:00-23:30)
    let franceStatus = { open: false, text: 'æœªå¼€å¸‚' };
    if (!isWeekend && ((hours >= 15 && hours < 23) || (hours === 23 && minutes <= 30))) {
        franceStatus = { open: true, text: 'äº¤æ˜“ä¸­' };
    }

    // ç¾æ´²å¸‚åœº
    // ç¾è‚¡çŠ¶æ€ (çº½çº¦ï¼ŒåŒ—äº¬æ—¶é—´21:30-4:00)
    let usStatus = { open: false, text: 'æœªå¼€å¸‚' };
    if ((hours >= 21 && minutes >= 30) || hours >= 22 || hours < 4) {
        // æ£€æŸ¥ç¾è‚¡çš„å·¥ä½œæ—¥ (å½“åŒ—äº¬æ—¶é—´æ˜¯å‘¨å…­æ—©ä¸Šï¼Œç¾å›½è¿˜æ˜¯å‘¨äº”)
        const usDay = hours < 12 ? (weekday === 6 ? 5 : weekday - 1) : weekday;
        if (usDay !== 0 && usDay !== 6) {
            usStatus = { open: true, text: 'äº¤æ˜“ä¸­' };
        }
    }

    // çº³æ–¯è¾¾å…‹ä¸ç¾è‚¡ç›¸åŒ
    let nasdaqStatus = usStatus;

    // å·´è¥¿è‚¡å¸‚ (åœ£ä¿ç½—ï¼ŒåŒ—äº¬æ—¶é—´20:30-3:00)
    let brazilStatus = { open: false, text: 'æœªå¼€å¸‚' };
    if ((hours >= 20 && minutes >= 30) || hours >= 21 || hours < 3) {
        const brazilDay = hours < 12 ? (weekday === 6 ? 5 : weekday - 1) : weekday;
        if (brazilDay !== 0 && brazilDay !== 6) {
            brazilStatus = { open: true, text: 'äº¤æ˜“ä¸­' };
        }
    }

    // æ›´æ–°DOM
    updateMarketStatusUI('china-market', chinaStatus);
    updateMarketStatusUI('hk-market', hkStatus);
    updateMarketStatusUI('taiwan-market', taiwanStatus);
    updateMarketStatusUI('japan-market', japanStatus);

    updateMarketStatusUI('uk-market', ukStatus);
    updateMarketStatusUI('german-market', germanStatus);
    updateMarketStatusUI('france-market', franceStatus);

    updateMarketStatusUI('us-market', usStatus);
    updateMarketStatusUI('nasdaq-market', nasdaqStatus);
    updateMarketStatusUI('brazil-market', brazilStatus);
}

// æ›´æ–°å¸‚åœºçŠ¶æ€UI
function updateMarketStatusUI(elementId, status) {
    const element = $(`#${elementId}`);
    const iconElement = element.find('i');
    const textElement = element.find('.status-text');

    if (status.open) {
        iconElement.removeClass('status-closed').addClass('status-open');
    } else {
        iconElement.removeClass('status-open').addClass('status-closed');
    }

    textElement.text(status.text);
}

// æ›´æ–°å€’è®¡æ—¶
function updateRefreshCountdown() {
    refreshCountdown--;

    if (refreshCountdown <= 0) {
        // é‡æ–°åŠ è½½é¡µé¢
        window.location.reload();
        return;
    }

    const minutes = Math.floor(refreshCountdown / 60);
    const seconds = refreshCountdown % 60;
    $('#refresh-time').text(`åˆ·æ–°: ${minutes}:${seconds < 10 ? '0' + seconds : seconds}`);
}

// æ›´æ–°å½“å‰æ—¶é—´
function updateCurrentTime() {
    const now = new Date();
    const timeString = now.toLocaleTimeString('zh-CN', { hour12: false });
    $('#current-time span').text(timeString);
}

// å¯åŠ¨æ»šåŠ¨æ–°é—»
function startTickerNews() {
    $.ajax({
        url: '/api/latest_news',
        method: 'GET',
        data: {
            days: 1,
            limit: 10
        },
        success: function(response) {
            if (response.success && response.news && response.news.length > 0) {
                displayTickerNews(response.news);
            } else {
                $('#ticker-container .ticker-wrapper').html('<div class="ticker-item">æš‚æ— æœ€æ–°æ¶ˆæ¯</div>');
            }
        },
        error: function(err) {
            console.error('è·å–æ»šåŠ¨æ–°é—»å¤±è´¥:', err);
            $('#ticker-container .ticker-wrapper').html('<div class="ticker-item">è·å–æœ€æ–°æ¶ˆæ¯å¤±è´¥</div>');
        }
    });
}

// æ˜¾ç¤ºæ»šåŠ¨æ–°é—»
function displayTickerNews(newsList) {
    if (newsList.length === 0) {
        $('#ticker-container .ticker-wrapper').html('<div class="ticker-item">æš‚æ— æœ€æ–°æ¶ˆæ¯</div>');
        return;
    }

    let tickerItems = '';

    newsList.forEach(news => {
        tickerItems += `<div class="ticker-item">${news.content || ''}</div>`;
    });

    $('#ticker-container .ticker-wrapper').html(tickerItems);

    // å¯åŠ¨æ»šåŠ¨æ•ˆæœ
    const tickerWidth = $('#ticker-container').width();
    const wrapper = $('#ticker-container .ticker-wrapper');

    wrapper.width(tickerWidth * 2);
    wrapper.css('animation', 'ticker 30s linear infinite');
}
</script>
{% endblock %}
